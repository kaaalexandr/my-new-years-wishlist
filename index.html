<!DOCTYPE html>
<html>
<head>
    <title>üéÑ –°–µ–º–µ–π–Ω—ã–π –í–∏—à–ª–∏—Å—Ç 2024 —Å –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º üéÅ</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* –í–°–Å –¢–í–û–Å CSS –û–°–¢–ê–í–õ–Ø–ï–ú –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô */
        /* ... –≤–µ—Å—å —Ç–≤–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π CSS ... */
    </style>
</head>
<body>
    <!-- –í–°–Ø –¢–í–û–Ø HTML –°–¢–†–£–ö–¢–£–†–ê –û–°–¢–ê–Å–¢–°–Ø -->
    <div class="container">
        <h1 class="family-header">üéÑ –°–ï–ú–ï–ô–ù–´–ô –í–ò–®–õ–ò–°–¢ 2024 üéÅ</h1>
        
        <div class="reserved-panel">
            <h3>üö´ –ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù–ù–´–ï –ü–û–î–ê–†–ö–ò:</h3>
            <div class="reserved-list" id="reservedList">
                <div style="color:#888; font-style:italic;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
        </div>
        
        <div class="gift-grid" id="giftGrid">
            <!-- –í—Å–µ 10 –ø–æ–¥–∞—Ä–∫–æ–≤ –∫–∞–∫ –±—ã–ª–æ -->
            <!-- ... -->
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal-overlay" id="reserveModal">
        <!-- ... -->
    </div>
    
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ -->
    <div class="status-message" id="statusMessage"></div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ===
        // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò –≠–¢–ò –î–ê–ù–ù–´–ï –ù–ê –°–í–û–ò –ò–ó FIREBASE CONSOLE ‚ö†Ô∏è
        const firebaseConfig = {
  apiKey: "AIzaSyA_57kHHb2D-EOSxaOVE4aD25qXT4oXmJU",
  authDomain: "wishlist-2026.firebaseapp.com",
  projectId: "wishlist-2026",
  storageBucket: "wishlist-2026.firebasestorage.app",
  messagingSenderId: "1072466643130",
  appId: "1:1072466643130:web:3b73da03ca11b73c3e5a83",
  measurementId: "G-7QHKJ0S164"
};
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        let gifts = {};
        let selectedGiftId = null;
        let selectedGiftTitle = '';
        
        // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° FIRESTORE ===
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏ –≤ Firestore
        async function saveToFirestore() {
            try {
                await db.collection('wishlist').doc('gifts').set({
                    data: gifts,
                    updatedAt: new Date().toISOString()
                });
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firestore');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showStatusMessage('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                return false;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏ –∏–∑ Firestore
        async function loadFromFirestore() {
            try {
                const doc = await db.collection('wishlist').doc('gifts').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    gifts = data.data || {};
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    Object.keys(gifts).forEach(id => {
                        if (gifts[id] && gifts[id].reserved) {
                            const giftCard = document.querySelector(`.gift-card[data-id="${id}"]`);
                            if (giftCard) {
                                giftCard.classList.add('reserved');
                                const reservedByDiv = document.getElementById(`reservedBy${id}`);
                                if (reservedByDiv) {
                                    reservedByDiv.style.display = 'block';
                                    
                                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è
                                    const nameInput = reservedByDiv.querySelector('input');
                                    if (nameInput && gifts[id].reservedBy) {
                                        nameInput.value = gifts[id].reservedBy;
                                    }
                                }
                            }
                        }
                    });
                    
                    updateReservedList();
                    showStatusMessage('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                    return true;
                } else {
                    // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π
                    gifts = {};
                    for (let i = 1; i <= 10; i++) {
                        gifts[i] = { reserved: false, reservedBy: '' };
                    }
                    await saveToFirestore();
                    return true;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fallback –¥–∞–Ω–Ω—ã–µ
                initializeDefaultGifts();
                return false;
            }
        }
        
        // –†–µ–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function setupRealtimeUpdates() {
            db.collection('wishlist').doc('gifts')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (JSON.stringify(data.data) !== JSON.stringify(gifts)) {
                            console.log('üîÑ –ü–æ–ª—É—á–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ Firestore');
                            
                            const oldGifts = { ...gifts };
                            gifts = data.data || {};
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏–≤—à–∏–µ—Å—è –ø–æ–¥–∞—Ä–∫–∏
                            Object.keys(gifts).forEach(id => {
                                if (JSON.stringify(oldGifts[id]) !== JSON.stringify(gifts[id])) {
                                    updateGiftCard(id);
                                }
                            });
                            
                            updateReservedList();
                        }
                    }
                }, (error) => {
                    console.error('–û—à–∏–±–∫–∞ real-time:', error);
                });
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–¥–∞—Ä–∫–∞
        function updateGiftCard(giftId) {
            const giftCard = document.querySelector(`.gift-card[data-id="${giftId}"]`);
            if (!giftCard) return;
            
            const gift = gifts[giftId];
            
            if (gift.reserved) {
                giftCard.classList.add('reserved');
                const reservedByDiv = document.getElementById(`reservedBy${giftId}`);
                if (reservedByDiv) {
                    reservedByDiv.style.display = 'block';
                    
                    const nameInput = reservedByDiv.querySelector('input');
                    if (nameInput && gift.reservedBy && gift.reservedBy !== nameInput.value) {
                        nameInput.value = gift.reservedBy;
                    }
                }
            } else {
                giftCard.classList.remove('reserved');
                const reservedByDiv = document.getElementById(`reservedBy${giftId}`);
                if (reservedByDiv) {
                    reservedByDiv.style.display = 'none';
                }
            }
        }
        
        // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò (–æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏, –Ω–æ —Å Firestore) ===
        
        function showReserveModal(giftId, giftTitle) {
            if (gifts[giftId]?.reserved) {
                showStatusMessage('‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω!');
                return;
            }
            
            selectedGiftId = giftId;
            selectedGiftTitle = giftTitle;
            
            document.getElementById('modalGiftInfo').innerHTML = 
                `<strong>–ü–æ–¥–∞—Ä–æ–∫ #${giftId}</strong><br>${giftTitle}`;
            
            document.getElementById('reserveModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('reserveModal').classList.remove('active');
            selectedGiftId = null;
            selectedGiftTitle = '';
        }
        
        async function confirmReservation() {
            if (!selectedGiftId) return;
            
            gifts[selectedGiftId] = {
                reserved: true,
                reservedBy: ''
            };
            
            updateGiftCard(selectedGiftId);
            updateReservedList();
            
            await saveToFirestore();
            showStatusMessage(`üéâ –ü–æ–¥–∞—Ä–æ–∫ #${selectedGiftId} –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω!`);
            
            closeModal();
        }
        
        async function updateReservedBy(giftId, name) {
            if (!gifts[giftId]) return;
            
            gifts[giftId].reservedBy = name.trim() || '–ê–Ω–æ–Ω–∏–º';
            await saveToFirestore();
            updateReservedList();
            
            if (name.trim()) {
                showStatusMessage(`üë§ –ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞ #${giftId}`);
            }
        }
        
        function updateReservedList() {
            const reservedList = document.getElementById('reservedList');
            const reservedGifts = Object.keys(gifts).filter(id => 
                gifts[id] && gifts[id].reserved
            );
            
            if (reservedGifts.length === 0) {
                reservedList.innerHTML = '<div style="color:#888; font-style:italic;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤</div>';
                return;
            }
            
            reservedList.innerHTML = reservedGifts.map(id => {
                const gift = gifts[id];
                const giftTitle = document.querySelector(`.gift-card[data-id="${id}"] .gift-title`)?.textContent || `–ü–æ–¥–∞—Ä–æ–∫ #${id}`;
                const name = gift.reservedBy || '–ê–Ω–æ–Ω–∏–º';
                
                return `
                    <div class="reserved-badge">
                        <span class="gift-number">${id}</span>
                        ${giftTitle}
                        <div class="reserved-by">–í—ã–±—Ä–∞–ª(–∞): ${name}</div>
                    </div>
                `;
            }).join('');
        }
        
        function showStatusMessage(text) {
            const message = document.getElementById('statusMessage');
            message.textContent = text;
            message.classList.add('show');
            
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }
        
        function initializeDefaultGifts() {
            gifts = {};
            for (let i = 1; i <= 10; i++) {
                gifts[i] = { reserved: false, reservedBy: '' };
            }
        }
        
        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            showStatusMessage('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firestore
            await loadFromFirestore();
            
            // –í–∫–ª—é—á–∞–µ–º real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            setupRealtimeUpdates();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('reserveModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
            
            // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ (–¥–ª—è –∞–¥–º–∏–Ω–∞)
            window.resetAll = async function() {
                if (confirm('‚ö†Ô∏è –°–ë–†–û–°–ò–¢–¨ –í–°–ï –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø?')) {
                    initializeDefaultGifts();
                    await saveToFirestore();
                    location.reload();
                }
            };
        });
    </script>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 9999;">
        <button onclick="resetAll()" style="
            background: #ff0000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            opacity: 0.3;
            cursor: pointer;
        " title="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è">‚ôªÔ∏è –°–ë–†–û–°</button>
    </div>
</body>
</html>
